---
title: "Exemplary usage of `calc.oddsratio.glm()`"
author: "Patrick Schratz"
date: "3 September 2016"
output: 
  html_document: 
    highlight: textmate
    number_sections: yes
    theme: readable
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

```{r, echo=FALSE}
calc.oddsratio.glm <- function(model, data, incr, quietly = FALSE) {
  
  if (class(model)[1] == "glm") {
    
    # get pred names and coefficients without intercept
    preds <- names(coefficients(model))[2:length(coefficients(model))]
    coef <- coefficients(model)[2:length(coefficients(model))]
  }
  
  if (class(model)[1] == "glmmPQL") {
    # get pred names and coefficients without intercept
    preds <- names(model$coefficients$fixed)[2:length(model$coefficients$fixed)]
    coef <- model$coefficients$fixed[2:length(model$coefficients$fixed)]
  }
  
  odds_ratios <- list()
  for (i in preds) {
    # check if predictor is numeric or integer
    if (is.numeric(data[[i]]) | is.integer(data[[i]])) {
      odds_ratios[[i]] <- round(exp(as.numeric(coef[[i]])* as.numeric(incr[[i]])), 3)
      incr1 <- as.numeric(incr[[i]])
      or <- odds_ratios[[i]]
    }
    # if pred is factor -> perform direct conversion to odds ratio
    else {
      odds_ratios[[i]] <- round(exp(as.numeric(coef[[i]])), 3)
      incr1 <- "Non numeric predictor. Refer to basis factor level!"
      or <- odds_ratios[[i]]
    }
    
    if (!quietly) {
      cat("Variable:   '", i, "'\nIncrement:  '", 
          incr1, "'\nOdds ratio: ", or, "\n\n", sep = "")
    }
  }
}
```

# Examples {.tabset}

## GLM

Create example data.   
Data source: http://www.ats.ucla.edu/stat/r/dae/logit.htm

```{r}
dat <- read.csv("http://www.ats.ucla.edu/stat/data/binary.csv")
dat$rank <- factor(dat$rank)
fit_glm <- glm(admit ~ gre + gpa + rank, data = dat, family = "binomial")
```

The function calculates ORs for specific increment steps for all predictors.  
Increments for numerical variabels need to be given in a list.  

Since predictor `rank` is a factor variable with four levels, we will get three odds ratio outputs refering to the basis factor level (here: rank1).  
The output is interpreted as follows: "Having `rank2` instead of `rank1` while holding all other values constant results in a decrease in odds of 49.1% (1-0.509)".

```{r}
calc.oddsratio.glm(fit_glm, dat, list(gre = 380, gpa = 5))
```

## GLMM (MASS::glmmPQL)

Create example data.  
Source: `MASS` package.

```{r}
library(nlme)
library(MASS)
data(bacteria)
fit_glmmPQL <- MASS::glmmPQL(y ~ trt + week, random = ~1 | ID,
                             family = binomial, data = bacteria, verbose = FALSE)
```

```{r}
calc.oddsratio.glm(fit_glmmPQL, bacteria, list(week = 5))
```

